name: Basic Windows Connect

on:
  workflow_dispatch:

jobs:
  connect:
    runs-on: self-hosted

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Create venv and install Ansible (WinRM deps)
        run: |
          set -e
          echo "üîß Python on runner:"
          python3 --version || true

          echo "üì¶ Creating venv‚Ä¶"
          python3 -m venv .venv
          . .venv/bin/activate

          echo "‚¨ÜÔ∏è Upgrading pip‚Ä¶"
          python -m pip install --upgrade pip

          echo "üì• Installing Ansible + WinRM deps‚Ä¶"
          python -m pip install "ansible==8.7.0" "pywinrm>=0.4.3" "requests-ntlm>=1.2.0"

          echo "‚ÑπÔ∏è Ansible version:"
          ansible --version

      - name: Run connect playbook (prints Connected successfully)
        env:
          PATH: ${{ github.workspace }}/.venv/bin:${{ env.PATH }}
          # Use domain credentials (recommended on domain-joined Windows)
          # Set these in GitHub Actions ‚Üí Secrets:
          #   WINDOWS_USER: MGMT\\m6137672
          #   WINDOWS_PASSWORD: <your domain password>
          WINDOWS_USER: ${{ secrets.WINDOWS_USER }}
          WINDOWS_PASSWORD: ${{ secrets.WINDOWS_PASSWORD }}
        run: |
          set -e
          . .venv/bin/activate

          echo "‚ñ∂ Running connect playbook with NTLM and explicit timeouts‚Ä¶"
          ansible-playbook -i inventory/hosts.ini playbooks/connect.yml \
            -e "ansible_user=${WINDOWS_USER} \
                ansible_password=${WINDOWS_PASSWORD} \
                ansible_connection=winrm \
                ansible_winrm_transport=ntlm \
                ansible_port=5985 \
                ansible_winrm_server_cert_validation=ignore \
                ansible_winrm_operation_timeout_sec=60 \
                ansible_winrm_read_timeout_sec=120" -vvv
