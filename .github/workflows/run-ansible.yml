name: Basic Windows Connect

on:
  workflow_dispatch:

jobs:
  connect:
    runs-on: self-hosted

    env:
      # ✅ Mandatory: credentials to authenticate to the Windows host
      WINDOWS_USER: "Pranay"
      WINDOWS_PASSWORD: "ThomsonReuters@1711"
      # ✅ Mandatory: target Windows host IP/DNS
      WINDOWS_HOST: "10.21.1.87"

    steps:
      - name: Generate minimal inventory and playbook
        shell: bash
        run: |
          mkdir -p inventory playbooks

          # Minimal inventory (only what's required)
          cat > inventory/hosts.ini <<'INI'
          [windows]
          winhost1 ansible_host=${WINDOWS_HOST}
          INI
          sed -i "s|\${WINDOWS_HOST}|${WINDOWS_HOST}|g" inventory/hosts.ini

          # Minimal playbook: win_ping + a simple message
          cat > playbooks/win-ping.yml <<'YAML'
          ---
          - name: Basic ping/pong to Windows host
            hosts: windows
            gather_facts: no
            tasks:
              - name: WinRM ping (pong expected)
                ansible.windows.win_ping:

              - name: Print Connected successfully
                ansible.builtin.debug:
                  msg: "Connected successfully"
          YAML

      - name: Run basic ping/pong
        shell: bash
        env:
          ANSIBLE_FORCE_COLOR: "true"
        run: |
          ansible-playbook -i inventory/hosts.ini playbooks/win-ping.yml \
            -e ansible_user="${WINDOWS_USER}" \
            -e ansible_password="${WINDOWS_PASSWORD}" \
            -e ansible_connection=winrm \
            -e ansible_winrm_transport=ntlm \
            -e ansible_port=5985 \
            -e ansible_winrm_scheme=http \
            -e ansible_winrm_server_cert_validation=ignore
