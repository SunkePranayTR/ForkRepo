name: Run Ansible Playbook

on:
  workflow_dispatch:

jobs:
  run-playbook:
    runs-on: self-hosted

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      # Use system Python on the self-hosted runner
      - name: Create venv and install Ansible + WinRM deps
        run: |
          echo "ğŸ”§ Using system Python:"
          which python3 || true
          python3 --version || true

          echo "ğŸ“¦ Creating virtual environmentâ€¦"
          python3 -m venv .venv
          source .venv/bin/activate

          echo "â¬†ï¸ Upgrading pip in venvâ€¦"
          python -m pip install --upgrade pip

          echo "ğŸ“¥ Installing Ansible and WinRM deps in venvâ€¦"
          python -m pip install "ansible==8.7.0" "pywinrm>=0.4.3" "requests-ntlm>=1.2.0"

          echo "â„¹ï¸ Ansible version (from venv):"
          ansible --version

      - name: Run Ansible Playbook
        env:
          PATH: ${{ github.workspace }}/.venv/bin:${{ env.PATH }}
          WINDOWS_USER: ${{ secrets.WINDOWS_USER }}
          WINDOWS_PASSWORD: ${{ secrets.WINDOWS_PASSWORD }}
        run: |
          echo "ğŸ”§ Activating venvâ€¦"
          source .venv/bin/activate

          echo "âœ… Python version:"
          python --version

          echo "âœ… Ansible version:"
          ansible --version

          echo "ğŸ“ Current working directory: $PWD"
          echo "ğŸ“‚ Repo files:"
          ls -la

          echo "ğŸ§­ Showing inventory file path and preview (credentials not printed):"
          echo " - inventory/hosts.ini"
          sed -n '1,120p' inventory/hosts.ini

          echo "ğŸ§ª Running playbook: playbooks/win-ping.yml"
          ansible-playbook -i inventory/hosts.ini playbooks/win-ping.yml -vv

          echo "ğŸ‰ Playbook finished"
