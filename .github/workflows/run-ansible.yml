name: Basic Windows Connect

on:
  workflow_dispatch:

jobs:
  connect:
    runs-on: self-hosted
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Create venv and install Ansible (WinRM deps)
        run: |
          set -e
          python3 -m venv .venv
          . .venv/bin/activate
          python -m pip install --upgrade pip
          python -m pip install "ansible==8.7.0" "pywinrm>=0.4.3" "requests-ntlm>=1.2.0"
          ansible --version

      - name: Run connect playbook (prints Connected successfully)
        env:
          PATH: ${{ github.workspace }}/.venv/bin:${{ env.PATH }}
          WINDOWS_USER: '.\\Pranay'
          WINDOWS_PASSWORD: "ThomsonReuters@1711"
        run: |
          set -e
          . .venv/bin/activate
          echo "Effective username: ${WINDOWS_USER}"
          ansible-playbook -i inventory/hosts.ini playbooks/win-ping.yml \
            -e "ansible_user=${WINDOWS_USER} \
                ansible_password=${WINDOWS_PASSWORD} \
                ansible_connection=winrm \
                ansible_winrm_transport=ntlm \
                ansible_port=5985 \
                ansible_winrm_scheme=http \
                ansible_winrm_server_cert_validation=ignore \
                ansible_winrm_operation_timeout_sec=60 \
                ansible_winrm_read_timeout_sec=120" -vvv
