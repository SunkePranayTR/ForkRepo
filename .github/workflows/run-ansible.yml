name: Run Ansible Playbook

on:
  workflow_dispatch:

jobs:
  run-playbook:
    # IMPORTANT: run on your self-hosted EC2 runner
    runs-on: self-hosted

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      # Use system Python on the self-hosted runner
      - name: Create venv and install Ansible + WinRM deps
        run: |
          set -e
          echo "üîß Using system Python:"
          command -v python3 || true
          python3 --version || true

          echo "üì¶ Creating virtual environment‚Ä¶"
          python3 -m venv .venv
          . .venv/bin/activate

          echo "‚¨ÜÔ∏è Upgrading pip in venv‚Ä¶"
          python -m pip install --upgrade pip

          echo "üì• Installing Ansible and WinRM deps in venv‚Ä¶"
          python -m pip install "ansible==8.7.0" "pywinrm>=0.4.3" "requests-ntlm>=1.2.0"

          echo "‚ÑπÔ∏è Ansible version (from venv):"
          ansible --version

      - name: Run Ansible Playbook
        env:
          # Ensure the venv's bin dir is on PATH for this step
          PATH: ${{ github.workspace }}/.venv/bin:${{ env.PATH }}

          # Inject GitHub Secrets as environment vars
          WINDOWS_USER: ${{ secrets.WINDOWS_USER }}
          WINDOWS_PASSWORD: ${{ secrets.WINDOWS_PASSWORD }}
        run: |
          set -e
          echo "üîß Activating venv‚Ä¶"
          . .venv/bin/activate

          echo "‚úÖ Python version:"
          python --version

          echo "‚úÖ Ansible version:"
          ansible --version

          echo "üìÇ Repo files (Python-only listing for portability):"
          python -c "import os, json; print(json.dumps(sorted(os.listdir('.')), indent=2))"

          echo "üß≠ inventory/hosts.ini preview (no secrets):"
          python -c "import pathlib; p=pathlib.Path('inventory/hosts.ini'); print(p.read_text() if p.exists() else 'inventory/hosts.ini not found')"

          echo 'üß™ Running playbook: playbooks/win-ping.yml'
          ansible-playbook -i inventory/hosts.ini playbooks/win-ping.yml \
            -e "ansible_user=$WINDOWS_USER ansible_password=$WINDOWS_PASSWORD ansible_connection=winrm ansible_winrm_transport=ntlm ansible_port=5985 ansible_winrm_server_cert_validation=ignore" -vv

          echo "üéâ Playbook finished"
